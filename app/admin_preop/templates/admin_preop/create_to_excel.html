{% extends "base.html" %}
{% block title %}Patient Register — Excel Auto{% endblock %}

{% block navbar %}{% endblock %}

{% block content %}

<style>
  .glass-card {
      backdrop-filter: blur(18px);
      background: rgba(255, 255, 255, 0.55);
  }
  .dropzone-hover {
      background: rgba(59, 130, 246, 0.08);
      border-color: #0284c7 !important;
  }
</style>

<div class="min-h-screen flex flex-col items-center justify-start px-6 py-10 bg-gradient-to-br from-sky-50 to-sky-100">

    <!-- 상단 병원 로고 헤더 -->
    <div class="flex items-center gap-3 mb-10">
        <img src="/static/images/checklist_logo.png" class="h-12" alt="logo">
        <span class="text-3xl font-bold text-sky-800">Patient Register (Excel Auto)</span>
    </div>

    <!-- 글래스 카드 -->
    <div class="glass-card max-w-3xl w-full rounded-2xl shadow-2xl border border-sky-200 p-10">

        <form id="excelForm" class="grid grid-cols-1 gap-8">

            {% set label_class = "block text-sm font-semibold text-slate-600 mb-1" %}
            {% set input_box = "flex items-center gap-2 border border-sky-200 rounded-xl px-4 py-3 bg-white focus-within:ring-2 focus-within:ring-sky-400" %}
            {% set input_class = "w-full outline-none text-slate-700 placeholder-slate-400" %}

            <!-- 1. 등록번호 입력 -->
            <div>
                <label class="{{ label_class }}">등록번호</label>
                <div class="{{ input_box }}">
                    <i data-lucide="hash" class="w-5 h-5 text-sky-600"></i>
                    <input id="patient_id_input"
                        type="text"
                        name="patient_id"
                        placeholder="예: 87654"
                        required
                        class="{{ input_class }}">
                </div>
            </div>

            <!-- 2. 엑셀 드래그 앤 드롭 -->
            <div>
                <label class="{{ label_class }}">엑셀 파일 업로드</label>

                <div id="dropZone"
                     class="border-2 border-dashed border-sky-300 rounded-xl p-10 text-center cursor-pointer transition bg-white">
                    <p class="text-sky-700 font-semibold text-lg">여기에 엑셀 파일을 끌어놓으세요</p>
                    <p class="text-slate-500 text-sm mt-1">등록번호와 일치하는 환자 정보를 자동으로 불러옵니다</p>
                </div>

                <!-- 숨겨진 파일 input -->
                <input type="file" id="excelFileInput" class="hidden" accept=".xlsx,.xls">
            </div>

            <!-- 하단 버튼 영역 -->
            <div class="flex justify-between items-center mt-4">

                <!-- 목록으로 돌아가기 -->
                <a href="{{ url_for('admin_preop.preop_list') }}"
                   class="px-6 py-3 rounded-xl bg-slate-200 text-slate-700 font-semibold 
                          hover:bg-slate-300 transition shadow">
                    목록으로 돌아가기
                </a>
            </div>

        </form>
    </div>
</div>

<script>
const dropZone = document.getElementById("dropZone");
const excelInput = document.getElementById("excelFileInput");
const patientIdField = document.getElementById("patient_id_input");

dropZone.addEventListener("click", () => excelInput.click());

dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("dropzone-hover");
});

dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("dropzone-hover");
});

dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("dropzone-hover");

    const file = e.dataTransfer.files[0];
    if (file) sendExcel(file);
});

excelInput.addEventListener("change", () => {
    const file = excelInput.files[0];
    if (file) sendExcel(file);
});

function sendExcel(file) {
    const patientId = patientIdField.value.trim();

    if (!patientId) {
        alert("먼저 등록번호를 입력해주세요!");
        return;
    }

    const formData = new FormData();
    formData.append("excel_file", file);
    formData.append("patient_id", patientId);

    fetch("/admin_preop/find_from_excel", {
        method: "POST",
        body: formData,
    })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                alert("환자 정보를 성공적으로 불러왔습니다!\n\n이제 수기 등록 페이지에서 확인 및 수정 후 저장하세요.");
            } else {
                alert(data.message);
            }
        });
}
</script>

{% endblock %}
