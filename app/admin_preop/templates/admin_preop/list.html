{% extends "base.html" %}
{% block title %}Patient List â€” ê´€ë¦¬ì{% endblock %}

{% block navbar %}{% endblock %}

{% block content %}

<style>
.glass-card {
    backdrop-filter: blur(18px);
    background: rgba(255, 255, 255, 0.55);
}
/* ê° ì—´ì˜ ëŒ€ëµì ì¸ í­ (px) */
.col-date      { width: 110px; }   /* ìˆ˜ìˆ ë‚ ì§œ */
.col-id        { width: 110px; }   /* ë“±ë¡ë²ˆí˜¸ */
.col-name      { width: 90px;  }   /* ì´ë¦„ */
.col-gender    { width: 60px;  }
.col-age       { width: 60px;  }
.col-phone     { width: 70px;  }
.col-surgery   { width: 360px; }   /* ìˆ˜ìˆ ëª…: ë„“ê²Œ */
.col-doctor    { width: 90px;  }
.col-action    { width: 70px;  }   /* ì œì¶œ/ë³´ê¸°/ìˆ˜ì •/ë§í¬/ì‚­ì œ */
</style>

<div class="min-h-screen bg-gradient-to-br from-sky-50 to-sky-100 px-6 py-10 flex flex-col items-center">

    <!-- í—¤ë” -->
    <div class="flex items-center gap-3 mb-10">
        <img src="/static/images/checklist_logo.png" class="h-12" alt="logo">
        <span class="text-3xl font-bold text-sky-800">Patient List</span>
    </div>

    <!-- ì¹´ë“œ ì‹œì‘ -->
    <div class="glass-card max-w-7xl w-full rounded-2xl shadow-2xl border border-sky-200 p-10">

        <!-- ê²€ìƒ‰ + ë“±ë¡ ë²„íŠ¼ -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-3">

            <!-- ê²€ìƒ‰ì°½ -->
            <form id="searchForm" method="GET" class="flex flex-wrap items-center gap-2">
                <input type="text" name="q" value="{{ q }}"
                    placeholder="ê²€ìƒ‰: ì´ë¦„ / ë“±ë¡ë²ˆí˜¸ / ì „í™” / ìˆ˜ìˆ ëª… / ì£¼ì¹˜ì˜"
                    class="border border-sky-300 rounded-lg px-3 py-2 w-60
                            focus:ring-sky-400 focus:border-sky-400">

                <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
                <button class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg">
                    ê²€ìƒ‰
                </button>

                <!-- ğŸ”¥ ë¦¬ì…‹ ë²„íŠ¼ (ê²€ìƒ‰ì–´/ë‚ ì§œ ì´ˆê¸°í™” â†’ ì˜¤ëŠ˜ë¡œ) -->
                <a href="{{ url_for('admin_preop.preop_list') }}"
                   class="bg-slate-300 hover:bg-slate-400 text-slate-800 px-4 py-2 rounded-lg">
                    ì´ˆê¸°í™”
                </a>
                <!-- ğŸ”µ ë‚ ì§œ í•„í„° -->
                <input type="date" name="date" id="filter_date"
                    value="{{ selected_date }}"
                    class="border border-sky-300 rounded-lg px-3 py-2 text-sm
                           focus:ring-sky-400 focus:border-sky-400">
            </form>

            <!-- í™˜ì ë“±ë¡ ë²„íŠ¼ -->
            <a href="{{ url_for('admin_preop.preop_create_excel_full') }}"
            class="bg-sky-600 hover:bg-sky-700 text-white px-5 py-2 rounded-xl shadow">
                + í™˜ì ë“±ë¡
            </a>

        </div>



        {% if not patients %}
            <p class="text-center text-slate-500 py-10">ë“±ë¡ëœ ë¬¸ì§„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% else %}

        <!-- í…Œì´ë¸” -->
        <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow">
            <table class="min-w-full text-sm text-slate-700 table-patient">
                <colgroup>
                    <col class="col-date">
                    <col class="col-id">
                    <col class="col-name">
                    <col class="col-gender">
                    <col class="col-age">
                    <col class="col-phone">
                    <col class="col-surgery">
                    <col class="col-doctor">
                    <col class="col-action">
                    <col class="col-action">
                    <col class="col-action">
                    <col class="col-action">
                    <col class="col-action">
                </colgroup>

                <!-- í—¤ë” -->
                <thead class="bg-sky-50 border-b">
                    <tr class="text-sky-800 font-semibold text-center">

                        <th class="px-2 py-3">ìˆ˜ìˆ ë‚ ì§œ</th>       <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ë“±ë¡ë²ˆí˜¸</th>       <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ì´ë¦„</th>           <!-- ì¼ë°˜ -->
                        <th class="px-2 py-3">ì„±ë³„</th>           <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ë‚˜ì´</th>           <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ì „í™”</th>
                        <th class="px-2 py-3">ìˆ˜ìˆ ëª…</th>         <!-- â˜… ë‘ ë°° ë„“ê²Œ -->                        
                        <th class="px-2 py-3">ì£¼ì¹˜ì˜</th>         <!-- ì¼ë°˜ -->
                        <th class="px-2 py-3">ì œì¶œ</th>           <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ìƒì„¸</th>           <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ìˆ˜ì •</th>           <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ë§í¬</th>           <!-- ì¢ê²Œ -->
                        <th class="px-2 py-3">ì‚­ì œ</th>
                    </tr>
                </thead>


                <tbody>
                    {% for p in patients %}
                    <tr class="border-b hover:bg-sky-50 transition">

                        <!-- ìˆ˜ìˆ ë‚ ì§œ -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            {{ p.surgery_date if p.surgery_date else "-" }}
                        </td>

                        <!-- ë“±ë¡ë²ˆí˜¸ -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            {{ p.patient_id }}
                        </td>

                        <!-- ì´ë¦„ -->
                        <td class="px-3 py-3 text-center font-semibold whitespace-nowrap">
                            {{ p.name }}
                        </td>

                        <!-- ì„±ë³„ -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            {% if p.gender == "M" %}
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs">ë‚¨</span>
                            {% elif p.gender == "F" %}
                                <span class="px-2 py-1 bg-pink-100 text-pink-700 rounded-lg text-xs">ì—¬</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- ë‚˜ì´ ê³„ì‚° -->
                        <td class="px-3 py-3 text-center">
                            {{ p.age if p.age else '-' }}
                        </td>
                        <!-- ì „í™”ë²ˆí˜¸ ì•„ì´ì½˜ -->
                        <td class="px-2 py-3 text-center w-16">
                            {% if p.phone %}
                                <button onclick="copyPhone('{{ p.phone }}')" 
                                        class="text-sky-600 hover:text-sky-800 transition">
                                    <i data-lucide="phone" class="w-5 h-5"></i>
                                </button>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <!-- ìˆ˜ìˆ ëª… -->
                        <td class="px-3 py-3 text-left truncate">
                            {{ p.surgery_name if p.surgery_name else "-" }}
                        </td>

                        <!-- ì£¼ì¹˜ì˜ -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            {{ p.doctor_name }}
                        </td>

                        <!-- ì œì¶œ ì—¬ë¶€ -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            {% if p.submitted %}
                                <span class="text-green-600 font-bold">ì™„ë£Œ</span>
                            {% else %}
                                <span class="text-red-500 font-bold">ë¯¸ì œì¶œ</span>
                            {% endif %}
                        </td>

                        <!-- ìƒì„¸ë³´ê¸° -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            <a href="{{ url_for('admin_preop.preop_view', patient_id=p.id) }}"
                               class="text-sky-600 hover:underline font-semibold">
                                ë³´ê¸°
                            </a>
                        </td>

                        <!-- ìˆ˜ì • -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            <a href="{{ url_for('admin_preop.preop_edit', patient_id=p.id) }}"
                               class="text-yellow-600 hover:underline font-semibold">
                                ìˆ˜ì •
                            </a>
                        </td>

                        <!-- ë§í¬ ë³µì‚¬ -->
                        <td class="px-3 py-3 text-center">
                            <button onclick="copyLink('{{ request.host_url }}preop/start/{{ p.token }}')"
                                    class="text-sky-600 hover:underline font-semibold">
                                <i data-lucide="copy" class="w-5 h-5"></i>
                            </button>
                        </td>
                        <!-- ì‚­ì œ -->
                        <td class="px-3 py-3 text-center whitespace-nowrap">
                            <button onclick="deletePatient({{ p.id }})"
                                    class="text-red-500 hover:text-red-700 font-semibold">
                                <i data-lucide='trash-2' class='w-5 h-5'></i>
                            </button>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
        {% if pagination.pages > 1 %}
        <div class="flex justify-center mt-6">

            <!-- ì´ì „ ë²„íŠ¼ -->
            {% if pagination.has_prev %}
                <a href="{{ url_for('admin_preop.preop_list', page=pagination.prev_num, q=q) }}"
                class="px-3 py-2 mx-1 bg-sky-100 text-sky-700 rounded-lg hover:bg-sky-200">
                    ì´ì „
                </a>
            {% endif %}

            <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if p %}
                    {% if p == pagination.page %}
                        <span class="px-3 py-2 mx-1 bg-sky-600 text-white rounded-lg">{{ p }}</span>
                    {% else %}
                        <a href="{{ url_for('admin_preop.preop_list', page=p, q=q) }}"
                        class="px-3 py-2 mx-1 bg-sky-100 text-sky-700 rounded-lg hover:bg-sky-200">
                            {{ p }}
                        </a>
                    {% endif %}
                {% else %}
                    <span class="px-3 py-2 mx-1">â€¦</span>
                {% endif %}
            {% endfor %}

            <!-- ë‹¤ìŒ ë²„íŠ¼ -->
            {% if pagination.has_next %}
                <a href="{{ url_for('admin_preop.preop_list', page=pagination.next_num, q=q) }}"
                class="px-3 py-2 mx-1 bg-sky-100 text-sky-700 rounded-lg hover:bg-sky-200">
                    ë‹¤ìŒ
                </a>
            {% endif %}

        </div>
        {% endif %}

        {% endif %}
    </div>
</div>
<div id="toastPhone"
     class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 
            bg-sky-700 text-white py-3 px-6 rounded-lg shadow-lg z-50
            transition opacity-0 duration-300">
    ì „í™”ë²ˆí˜¸ê°€ ë³µì‚¬ ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>
<div id="toastLink"
     class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 
            bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg z-50
            transition opacity-0 duration-300">
    ê²½ë¡œê°€ ë³µì‚¬ ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>
<!-- ë“±ë¡ ì„±ê³µ í† ìŠ¤íŠ¸ -->
<div id="toastRegister"
     class="hidden fixed top-10 left-1/2 transform -translate-x-1/2
            bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg z-50
            transition opacity-0 duration-300">
    í™˜ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>


<script>
function copyLink(url) {
    navigator.clipboard.writeText(url);

    const toast = document.getElementById("toastLink");
    toast.classList.remove("hidden");
    toast.style.opacity = "1";

    setTimeout(() => {
        toast.style.opacity = "0";
    }, 2500);

    setTimeout(() => {
        toast.classList.add("hidden");
    }, 3000);
}
function copyPhone(phone) {
    navigator.clipboard.writeText(phone);

    const toast = document.getElementById("toastPhone");
    toast.classList.remove("hidden");
    toast.style.opacity = "1";

    setTimeout(() => {
        toast.style.opacity = "0";
    }, 2500);

    setTimeout(() => {
        toast.classList.add("hidden");
    }, 3000);
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const messages = JSON.parse('{{ get_flashed_messages(with_categories=true) | tojson | safe }}');

    if (messages.length > 0) {
        const category = messages[0][0];
        const msg = messages[0][1];

        if (category === "success") {
            const toast = document.getElementById("toastRegister");
            toast.textContent = msg;
            toast.classList.remove("hidden");
            toast.style.opacity = "1";

            setTimeout(() => { toast.style.opacity = "0"; }, 2500);
            setTimeout(() => { toast.classList.add("hidden"); }, 3000);
        }
    }
});

function deletePatient(patientId) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ í™˜ì ì •ë³´ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
        return;
    }

    fetch(`/admin/preop/delete/${patientId}`, {
        method: "DELETE",
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } else {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + data.message);
        }
    })
    .catch(err => {
        alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        console.error(err);
    });
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dateInput  = document.getElementById("filter_date");
    const searchForm = document.getElementById("searchForm");

    if (dateInput && searchForm) {
        // ë‚ ì§œ ë³€ê²½ë˜ë©´ ìë™ìœ¼ë¡œ ëª©ë¡ ë‹¤ì‹œ ì¡°íšŒ
        dateInput.addEventListener("change", function () {
            searchForm.submit();
        });
    }
});
</script>

{% endblock %}

