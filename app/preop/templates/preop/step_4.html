{% extends "preop/step_base.html" %}
{% set hide_nav = True %}
{% set title = "ë³µìš©ì•½ ë° ê³¼ê±° ìˆ˜ìˆ  ê²½í—˜" %}

{% block form_fields %}

<div class="space-y-4">

    <!-- 1. ë³µìš© ì¤‘ì¸ ê²½êµ¬ì•½ -->
    <div class="disease-group" data-field="oral_med">
        <label class="font-semibold text-sky-700">1. ë³µìš© ì¤‘ì¸ ê²½êµ¬ì•½</label>

        <div class="flex items-center gap-6 mt-2">
            <label>
                <input type="radio" name="oral_med" value="ë¬´"
                       class="radio-none"
                       {% if saved.oral_med == "ë¬´" %} checked {% endif %}> ë¬´
            </label>

            <label>
                <input type="radio" name="oral_med" value="ìœ "
                       class="radio-yes"
                       {% if saved.oral_med == "ìœ " %} checked {% endif %}> ìœ 
            </label>
        </div>

        <!-- ì„¤ëª… -->
        <input name="oral_med_desc"
               value="{{ saved.oral_med_desc or '' }}"
               class="w-full border rounded-lg px-3 py-2 mt-3 desc-box
                      {% if saved.oral_med != 'ìœ ' %} hidden {% endif %}"
               placeholder="ë³µìš© ì¤‘ì¸ ì•½ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">

        <!-- ì‚¬ì§„ ì²¨ë¶€ -->
        <div class="mt-3 desc-box {% if saved.oral_med != 'ìœ ' %} hidden {% endif %}">
            <label class="block text-sm mb-1 text-slate-700">ê´€ë ¨ ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label>
            <input type="file"
                   name="oral_med_image"
                   accept="image/*"
                   capture="camera"
                   class="w-full border rounded-lg px-3 py-2">
        </div>
    </div>

    <!-- 2. ì…ì› ë° ê³¼ê±° ìˆ˜ìˆ  ê²½í—˜ -->
    <div class="disease-group" data-field="surgery_history">
        <label class="font-semibold text-sky-700">2. ì…ì› ë° ê³¼ê±° ìˆ˜ìˆ  ê²½í—˜</label>

        <div class="flex items-center gap-6 mt-2">
            <label>
                <input type="radio" name="surgery_history" value="ë¬´"
                       class="radio-none"
                       {% if saved.surgery_history == "ë¬´" %} checked {% endif %}> ë¬´
            </label>

            <label>
                <input type="radio" name="surgery_history" value="ìœ "
                       class="radio-yes"
                       {% if saved.surgery_history == "ìœ " %} checked {% endif %}> ìœ 
            </label>
        </div>

        <!-- ì„¤ëª… -->
        <div id="surgery-history-wrapper"
            class="space-y-2 mt-3 desc-box {% if saved.surgery_history != 'ìœ ' %} hidden {% endif %}">
            
            {% if saved.surgery_history_desc_list %}
                {% for item in saved.surgery_history_desc_list %}
                    <div class="flex gap-2 surgery-item">
                        <input name="surgery_history_desc[]" 
                            value="{{ item }}"
                            class="w-full border rounded-lg px-3 py-2">
                        <button type="button"
                                class="remove-btn text-red-500 font-bold px-2">âˆ’</button>
                    </div>
                {% endfor %}
            {% else %}
                <!-- ê¸°ë³¸ 1ì¹¸ ìƒì„± -->
                <div class="flex gap-2 surgery-item">
                    <input name="surgery_history_desc[]" 
                        class="w-full border rounded-lg px-3 py-2"
                        placeholder="ì˜ˆ: 2020ë…„ ì˜¤ë¥¸ìª½ ë¬´ë¦ ì¸ê³µê´€ì ˆìˆ˜ìˆ .">
                    <button type="button"
                            class="remove-btn text-red-500 font-bold px-2">âˆ’</button>
                </div>
            {% endif %}
        </div>

        <!-- + ì¶”ê°€ ë²„íŠ¼ -->
        <button type="button"
                id="add-surgery-btn"
                class="mt-2 px-3 py-1 bg-sky-600 text-white rounded-md
                    {% if saved.surgery_history != 'ìœ ' %} hidden {% endif %}">
            + ì¶”ê°€
        </button>

    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* =====================================
       ğŸ”µ ìœ /ë¬´ ì„ íƒ ì‹œ desc-box ìë™ í‘œì‹œ
       ===================================== */
    document.querySelectorAll(".disease-group").forEach(group => {
        const yes = group.querySelector(".radio-yes");
        const no = group.querySelector(".radio-none");
        const boxes = group.querySelectorAll(".desc-box");

        if (yes) {
            yes.addEventListener("change", () => {
                boxes.forEach(b => b.classList.remove("hidden"));
            });
        }

        if (no) {
            no.addEventListener("change", () => {
                boxes.forEach(b => b.classList.add("hidden"));
            });
        }
    });


    /* =====================================
       ğŸ”µ â€œê³¼ê±° ìˆ˜ìˆ  ê²½í—˜ - ì¶”ê°€í•˜ê¸°â€ ê¸°ëŠ¥
       ===================================== */
    const wrapper = document.getElementById("surgery-history-wrapper");
    const addBtn = document.getElementById("add-surgery-btn");

    // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ ì¹¸ ì¶”ê°€
    if (addBtn && wrapper) {
        addBtn.addEventListener("click", () => {
            const div = document.createElement("div");
            div.className = "flex gap-2 surgery-item";

            div.innerHTML = `
                <input name="surgery_history_desc[]" 
                       class="w-full border rounded-lg px-3 py-2"
                       placeholder="ì˜ˆ: 2021ë…„ ì™¼ìª½ ë¬´ë¦ ë°˜ì›”ìƒì—°ê³¨ ìˆ˜ìˆ ">
                <button type="button" class="remove-btn text-red-500 font-bold px-2">âˆ’</button>
            `;
            wrapper.appendChild(div);
        });
    }

    // ë™ì ìœ¼ë¡œ ì¶”ê°€ëœ ì‚­ì œ ë²„íŠ¼ ê¸°ëŠ¥
    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-btn")) {
            e.target.closest(".surgery-item").remove();
        }
    });

});
</script>


{% endblock %}
